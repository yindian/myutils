--- gb18030.c.orig	2006-08-17 10:18:26.000000000 +0900
+++ gb18030.c	2011-01-10 03:43:42.000000000 +0900
@@ -6109,7 +6109,7 @@
    ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 */
 
-static const uint16_t __fourbyte_to_ucs[39419-11172-4295] =
+static uint16_t __fourbyte_to_ucs[39419-11172-4295] =
 {
   [0x0000] = 0x0080, [0x0001] = 0x0081, [0x0002] = 0x0082, [0x0003] = 0x0083,
   [0x0004] = 0x0084, [0x0005] = 0x0085, [0x0006] = 0x0086, [0x0007] = 0x0087,
@@ -6275,7 +6275,7 @@
   [0x02c8] = 0x0374, [0x02c9] = 0x0375, [0x02ce] = 0x037a, [0x02d2] = 0x037e,
   [0x02d8] = 0x0384, [0x02d9] = 0x0385, [0x02da] = 0x0386, [0x02db] = 0x0387,
   [0x02dc] = 0x0388, [0x02dd] = 0x0389, [0x02de] = 0x038a, [0x02e0] = 0x038c,
-  [0x02e2] = 0x038e, [0x02e3] = 0x038f, [0x02e4] = 0x0390, [0x02e6] = 0x03aa,
+  [0x02e2] = 0x038e, [0x02e3] = 0x038f, [0x02e4] = 0x0390, [0x02e5] = 0x03a2, [0x02e6] = 0x03aa,
   [0x02e7] = 0x03ab, [0x02e8] = 0x03ac, [0x02e9] = 0x03ad, [0x02ea] = 0x03ae,
   [0x02eb] = 0x03af, [0x02ec] = 0x03b0, [0x02ed] = 0x03c2, [0x02ee] = 0x03ca,
   [0x02ef] = 0x03cb, [0x02f0] = 0x03cc, [0x02f1] = 0x03cd, [0x02f2] = 0x03ce,
@@ -7407,7 +7407,7 @@
   [0x202b] = 0x215f, [0x202c] = 0x216c, [0x202d] = 0x216d, [0x202e] = 0x216e,
   [0x202f] = 0x216f, [0x2030] = 0x217a, [0x2031] = 0x217b, [0x2032] = 0x217c,
   [0x2033] = 0x217d, [0x2034] = 0x217e, [0x2035] = 0x217f, [0x2036] = 0x2180,
-  [0x2037] = 0x2181, [0x2038] = 0x2182, [0x2039] = 0x2183, [0x2046] = 0x2194,
+  [0x2037] = 0x2181, [0x2038] = 0x2182, [0x2039] = 0x2183, [0x2040] = 0x218a, [0x2045] = 0x218f, [0x2046] = 0x2194,
   [0x2047] = 0x2195, [0x2048] = 0x219a, [0x2049] = 0x219b, [0x204a] = 0x219c,
   [0x204b] = 0x219d, [0x204c] = 0x219e, [0x204d] = 0x219f, [0x204e] = 0x21a0,
   [0x204f] = 0x21a1, [0x2050] = 0x21a2, [0x2051] = 0x21a3, [0x2052] = 0x21a4,
@@ -7552,7 +7552,7 @@
   [0x22ac] = 0x2424, [0x22ad] = 0x2425, [0x22ae] = 0x2426, [0x22c8] = 0x2440,
   [0x22c9] = 0x2441, [0x22ca] = 0x2442, [0x22cb] = 0x2443, [0x22cc] = 0x2444,
   [0x22cd] = 0x2445, [0x22ce] = 0x2446, [0x22cf] = 0x2447, [0x22d0] = 0x2448,
-  [0x22d1] = 0x2449, [0x22d2] = 0x244a, [0x22e8] = 0x246a, [0x22e9] = 0x246b,
+  [0x22d1] = 0x2449, [0x22d2] = 0x244a, [0x22e7] = 0x245f, [0x22e8] = 0x246a, [0x22e9] = 0x246b,
   [0x22ea] = 0x246c, [0x22eb] = 0x246d, [0x22ec] = 0x246e, [0x22ed] = 0x246f,
   [0x22ee] = 0x2470, [0x22ef] = 0x2471, [0x22f0] = 0x2472, [0x22f1] = 0x2473,
   [0x22f2] = 0x249c, [0x22f3] = 0x249d, [0x22f4] = 0x249e, [0x22f5] = 0x249f,
@@ -7579,7 +7579,7 @@
   [0x2346] = 0x24f0, [0x2347] = 0x24f1, [0x2348] = 0x24f2, [0x2349] = 0x24f3,
   [0x234a] = 0x24f4, [0x234b] = 0x24f5, [0x234c] = 0x24f6, [0x234d] = 0x24f7,
   [0x234e] = 0x24f8, [0x234f] = 0x24f9, [0x2350] = 0x24fa, [0x2351] = 0x24fb,
-  [0x2352] = 0x24fc, [0x2353] = 0x24fd, [0x2354] = 0x24fe, [0x2356] = 0x254c,
+  [0x2352] = 0x24fc, [0x2353] = 0x24fd, [0x2354] = 0x24fe, [0x2355] = 0x24ff, [0x2356] = 0x254c,
   [0x2357] = 0x254d, [0x2358] = 0x254e, [0x2359] = 0x254f, [0x235a] = 0x2574,
   [0x235b] = 0x2575, [0x235c] = 0x2576, [0x235d] = 0x2577, [0x235e] = 0x2578,
   [0x235f] = 0x2579, [0x2360] = 0x257a, [0x2361] = 0x257b, [0x2362] = 0x257c,
@@ -7964,18 +7964,19 @@
   [0x2d79] = 0x2fc7, [0x2d7a] = 0x2fc8, [0x2d7b] = 0x2fc9, [0x2d7c] = 0x2fca,
   [0x2d7d] = 0x2fcb, [0x2d7e] = 0x2fcc, [0x2d7f] = 0x2fcd, [0x2d80] = 0x2fce,
   [0x2d81] = 0x2fcf, [0x2d82] = 0x2fd0, [0x2d83] = 0x2fd1, [0x2d84] = 0x2fd2,
-  [0x2d85] = 0x2fd3, [0x2d86] = 0x2fd4, [0x2d87] = 0x2fd5, [0x2da6] = 0x3004,
+  [0x2d85] = 0x2fd3, [0x2d86] = 0x2fd4, [0x2d87] = 0x2fd5,
+  [0x2da1] = 0x2fef, [0x2da2] = 0x2ffc, [0x2da5] = 0x2fff, [0x2da6] = 0x3004,
   [0x2da7] = 0x3018, [0x2da8] = 0x3019, [0x2da9] = 0x301a, [0x2daa] = 0x301b,
   [0x2dab] = 0x301c, [0x2dac] = 0x301f, [0x2dad] = 0x3020, [0x2dae] = 0x302a,
   [0x2daf] = 0x302b, [0x2db0] = 0x302c, [0x2db1] = 0x302d, [0x2db2] = 0x302e,
   [0x2db3] = 0x302f, [0x2db4] = 0x3030, [0x2db5] = 0x3031, [0x2db6] = 0x3032,
   [0x2db7] = 0x3033, [0x2db8] = 0x3034, [0x2db9] = 0x3035, [0x2dba] = 0x3036,
   [0x2dbb] = 0x3037, [0x2dbc] = 0x3038, [0x2dbd] = 0x3039, [0x2dbe] = 0x303a,
-  [0x2dbf] = 0x303b, [0x2dc0] = 0x303c, [0x2dc1] = 0x303d, [0x2dc2] = 0x303f,
+  [0x2dbf] = 0x303b, [0x2dc0] = 0x303c, [0x2dc1] = 0x303d, [0x2dc2] = 0x303f, [0x2dc3] = 0x3040,
   [0x2dc4] = 0x3094, [0x2dc5] = 0x3095, [0x2dc6] = 0x3096, [0x2dc9] = 0x3099,
   [0x2dca] = 0x309a, [0x2dcb] = 0x309f, [0x2dcc] = 0x30a0, [0x2dcd] = 0x30f7,
   [0x2dce] = 0x30f8, [0x2dcf] = 0x30f9, [0x2dd0] = 0x30fa, [0x2dd1] = 0x30fb,
-  [0x2dd2] = 0x30ff, [0x2dd8] = 0x312a, [0x2dd9] = 0x312b, [0x2dda] = 0x312c,
+  [0x2dd2] = 0x30ff, [0x2dd7] = 0x3104, [0x2dd8] = 0x312a, [0x2dd9] = 0x312b, [0x2dda] = 0x312c,
   [0x2ddf] = 0x3131, [0x2de0] = 0x3132, [0x2de1] = 0x3133, [0x2de2] = 0x3134,
   [0x2de3] = 0x3135, [0x2de4] = 0x3136, [0x2de5] = 0x3137, [0x2de6] = 0x3138,
   [0x2de7] = 0x3139, [0x2de8] = 0x313a, [0x2de9] = 0x313b, [0x2dea] = 0x313c,
@@ -8020,7 +8021,7 @@
   [0x2ebc] = 0x320e, [0x2ebd] = 0x320f, [0x2ebe] = 0x3210, [0x2ebf] = 0x3211,
   [0x2ec0] = 0x3212, [0x2ec1] = 0x3213, [0x2ec2] = 0x3214, [0x2ec3] = 0x3215,
   [0x2ec4] = 0x3216, [0x2ec5] = 0x3217, [0x2ec6] = 0x3218, [0x2ec7] = 0x3219,
-  [0x2ec8] = 0x321a, [0x2ec9] = 0x321b, [0x2eca] = 0x321c, [0x2ece] = 0x322a,
+  [0x2ec8] = 0x321a, [0x2ec9] = 0x321b, [0x2eca] = 0x321c, [0x2ecd] = 0x321f, [0x2ece] = 0x322a,
   [0x2ecf] = 0x322b, [0x2ed0] = 0x322c, [0x2ed1] = 0x322d, [0x2ed2] = 0x322e,
   [0x2ed3] = 0x322f, [0x2ed4] = 0x3230, [0x2ed5] = 0x3232, [0x2ed6] = 0x3233,
   [0x2ed7] = 0x3234, [0x2ed8] = 0x3235, [0x2ed9] = 0x3236, [0x2eda] = 0x3237,
@@ -9760,7 +9761,8 @@
   [0x4a0b] = 0x4da7, [0x4a0c] = 0x4da8, [0x4a0d] = 0x4da9, [0x4a0e] = 0x4daa,
   [0x4a0f] = 0x4dab, [0x4a10] = 0x4dac, [0x4a11] = 0x4dad, [0x4a12] = 0x4daf,
   [0x4a13] = 0x4db0, [0x4a14] = 0x4db1, [0x4a15] = 0x4db2, [0x4a16] = 0x4db3,
-  [0x4a17] = 0x4db4, [0x4a18] = 0x4db5, [0x4abd] = 0xa000, [0x4abe] = 0xa001,
+  [0x4a17] = 0x4db4, [0x4a18] = 0x4db5, [0x4a62] = 0x4dff, [0x4a63] = 0x9fa6,
+                                        [0x4abd] = 0xa000, [0x4abe] = 0xa001,
   [0x4abf] = 0xa002, [0x4ac0] = 0xa003, [0x4ac1] = 0xa004, [0x4ac2] = 0xa005,
   [0x4ac3] = 0xa006, [0x4ac4] = 0xa007, [0x4ac5] = 0xa008, [0x4ac6] = 0xa009,
   [0x4ac7] = 0xa00a, [0x4ac8] = 0xa00b, [0x4ac9] = 0xa00c, [0x4aca] = 0xa00d,
@@ -10065,7 +10067,7 @@
   [0x4f76] = 0xa4b9, [0x4f77] = 0xa4ba, [0x4f78] = 0xa4bb, [0x4f79] = 0xa4bc,
   [0x4f7a] = 0xa4bd, [0x4f7b] = 0xa4be, [0x4f7c] = 0xa4bf, [0x4f7d] = 0xa4c0,
   [0x4f7e] = 0xa4c1, [0x4f7f] = 0xa4c2, [0x4f80] = 0xa4c3, [0x4f81] = 0xa4c4,
-  [0x4f82] = 0xa4c5, [0x4f83] = 0xa4c6, [0x5719] = 0xe76c, [0x571a] = 0xe7c8,
+  [0x4f82] = 0xa4c5, [0x4f83] = 0xa4c6, [0x5718] = 0xac5b, [0x5719] = 0xe76c, [0x571a] = 0xe7c8,
   [0x571b] = 0xe7e7, [0x571c] = 0xe7e8, [0x571d] = 0xe7e9, [0x571e] = 0xe7ea,
   [0x571f] = 0xe7eb, [0x5720] = 0xe7ec, [0x5721] = 0xe7ed, [0x5722] = 0xe7ee,
   [0x5723] = 0xe7ef, [0x5724] = 0xe7f0, [0x5725] = 0xe7f1, [0x5726] = 0xe7f2,
@@ -10327,8 +10329,9 @@
   [0x5c2e] = 0xfe05, [0x5c2f] = 0xfe06, [0x5c30] = 0xfe07, [0x5c31] = 0xfe08,
   [0x5c32] = 0xfe09, [0x5c33] = 0xfe0a, [0x5c34] = 0xfe0b, [0x5c35] = 0xfe0c,
   [0x5c36] = 0xfe0d, [0x5c37] = 0xfe0e, [0x5c38] = 0xfe0f, [0x5c49] = 0xfe20,
-  [0x5c4a] = 0xfe21, [0x5c4b] = 0xfe22, [0x5c4c] = 0xfe23, [0x5c59] = 0xfe32,
-  [0x5c5a] = 0xfe45, [0x5c5b] = 0xfe46, [0x5c5f] = 0xfe58, [0x5c65] = 0xfe70,
+  [0x5c4a] = 0xfe21, [0x5c4b] = 0xfe22, [0x5c4c] = 0xfe23, [0x5c58] = 0xfe2f, [0x5c59] = 0xfe32,
+  [0x5c5a] = 0xfe45, [0x5c5b] = 0xfe46, [0x5c5d] = 0xfe48, [0x5c5e] = 0xfe53,
+  [0x5c5f] = 0xfe58, [0x5c60] = 0xfe67, [0x5c61] = 0xfe6c, [0x5c65] = 0xfe70,
   [0x5c66] = 0xfe71, [0x5c67] = 0xfe72, [0x5c68] = 0xfe73, [0x5c69] = 0xfe74,
   [0x5c6b] = 0xfe76, [0x5c6c] = 0xfe77, [0x5c6d] = 0xfe78, [0x5c6e] = 0xfe79,
   [0x5c6f] = 0xfe7a, [0x5c70] = 0xfe7b, [0x5c71] = 0xfe7c, [0x5c72] = 0xfe7d,
@@ -10363,7 +10366,7 @@
   [0x5ce3] = 0xfeee, [0x5ce4] = 0xfeef, [0x5ce5] = 0xfef0, [0x5ce6] = 0xfef1,
   [0x5ce7] = 0xfef2, [0x5ce8] = 0xfef3, [0x5ce9] = 0xfef4, [0x5cea] = 0xfef5,
   [0x5ceb] = 0xfef6, [0x5cec] = 0xfef7, [0x5ced] = 0xfef8, [0x5cee] = 0xfef9,
-  [0x5cef] = 0xfefa, [0x5cf0] = 0xfefb, [0x5cf1] = 0xfefc, [0x5cf4] = 0xfeff,
+  [0x5cef] = 0xfefa, [0x5cf0] = 0xfefb, [0x5cf1] = 0xfefc, [0x5cf4] = 0xfeff, [0x5cf5] = 0xff00,
   [0x5cf6] = 0xff5f, [0x5cf7] = 0xff60, [0x5cf8] = 0xff61, [0x5cf9] = 0xff62,
   [0x5cfa] = 0xff63, [0x5cfb] = 0xff64, [0x5cfc] = 0xff65, [0x5cfd] = 0xff66,
   [0x5cfe] = 0xff67, [0x5cff] = 0xff68, [0x5d00] = 0xff69, [0x5d01] = 0xff6a,
@@ -10393,7 +10396,7 @@
   [0x5d63] = 0xffcc, [0x5d64] = 0xffcd, [0x5d65] = 0xffce, [0x5d66] = 0xffcf,
   [0x5d69] = 0xffd2, [0x5d6a] = 0xffd3, [0x5d6b] = 0xffd4, [0x5d6c] = 0xffd5,
   [0x5d6d] = 0xffd6, [0x5d6e] = 0xffd7, [0x5d71] = 0xffda, [0x5d72] = 0xffdb,
-  [0x5d73] = 0xffdc, [0x5d77] = 0xffe6, [0x5d79] = 0xffe8, [0x5d7a] = 0xffe9,
+  [0x5d73] = 0xffdc, [0x5d76] = 0xffdf, [0x5d77] = 0xffe6, [0x5d79] = 0xffe8, [0x5d7a] = 0xffe9,
   [0x5d7b] = 0xffea, [0x5d7c] = 0xffeb, [0x5d7d] = 0xffec, [0x5d7e] = 0xffed,
   [0x5d7f] = 0xffee, [0x5d8a] = 0xfff9, [0x5d8b] = 0xfffa, [0x5d8c] = 0xfffb,
   [0x5d8d] = 0xfffc, [0x5d8e] = 0xfffd,
@@ -25736,6 +25739,8 @@
 		ch = idx + 0x6557; 					      \
 	      else if (idx > 0x93d4 && idx < 0x99fb)		              \
 		ch = __fourbyte_to_ucs[idx-11172-4295];			      \
+	      else if (idx >= 0x2e248)              		              \
+		ch = idx - 0x1e248;                    			      \
 	      else							      \
 		ch = 0;							      \
 									      \
@@ -25833,7 +25838,10 @@
             if ((cp[0] == 0)&&(cp[1] == 0)) len = 0;                          \
 	  }								      \
 	else  								      \
-	  len = 0;							      \
+	  {								      \
+	    idx = ch + 0x1e248;						      \
+	    len = 4;							      \
+	  }								      \
 									      \
 	if (__builtin_expect (len, 2) == 0				      \
 	    || (len == 2 && __builtin_expect (cp[0], '\1') == '\0'))          \
@@ -25886,3 +25894,31 @@
 
 /* Now define the toplevel functions.  */
 #include <iconv/skeleton.c>
+
+#include <stdio.h>
+#include <assert.h>
+/* Initialization: fill the holes in __fourbyte_to_ucs table */
+__attribute__((constructor))
+static void initialize_gb18030()
+{
+    int i;
+    int lastz = 0;
+    for (i = 0; i < sizeof(__fourbyte_to_ucs) / sizeof(__fourbyte_to_ucs[0]); i++)
+    {
+        if (__fourbyte_to_ucs[i] == 0 && i > 0)
+        {
+            __fourbyte_to_ucs[i] = __fourbyte_to_ucs[i-1] + 1;
+            lastz = 1;
+        }
+        else
+        {
+            if (lastz)
+            {
+                if (__fourbyte_to_ucs[i] != __fourbyte_to_ucs[i-1] + 1)
+                    fprintf(stderr, "i=0x%04x, __fourbyte_to_ucs[i]=0x%04x\n", i, __fourbyte_to_ucs[i]);
+                assert(__fourbyte_to_ucs[i] == __fourbyte_to_ucs[i-1] + 1);
+            }
+            lastz = 0;
+        }
+    }
+}
