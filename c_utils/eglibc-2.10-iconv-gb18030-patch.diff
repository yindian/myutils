--- gb18030.c.orig	2006-08-17 10:18:26.000000000 +0900
+++ gb18030.c	2011-01-10 01:45:18.000000000 +0900
@@ -6109,7 +6109,7 @@
    ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 */
 
-static const uint16_t __fourbyte_to_ucs[39419-11172-4295] =
+static uint16_t __fourbyte_to_ucs[39419-11172-4295] =
 {
   [0x0000] = 0x0080, [0x0001] = 0x0081, [0x0002] = 0x0082, [0x0003] = 0x0083,
   [0x0004] = 0x0084, [0x0005] = 0x0085, [0x0006] = 0x0086, [0x0007] = 0x0087,
@@ -25736,6 +25736,8 @@
 		ch = idx + 0x6557; 					      \
 	      else if (idx > 0x93d4 && idx < 0x99fb)		              \
 		ch = __fourbyte_to_ucs[idx-11172-4295];			      \
+	      else if (idx >= 0x2e248)              		              \
+		ch = idx - 0x1e248;                    			      \
 	      else							      \
 		ch = 0;							      \
 									      \
@@ -25833,7 +25835,10 @@
             if ((cp[0] == 0)&&(cp[1] == 0)) len = 0;                          \
 	  }								      \
 	else  								      \
-	  len = 0;							      \
+	  {								      \
+	    idx = ch + 0x1e248;						      \
+	    len = 4;							      \
+	  }								      \
 									      \
 	if (__builtin_expect (len, 2) == 0				      \
 	    || (len == 2 && __builtin_expect (cp[0], '\1') == '\0'))          \
@@ -25886,3 +25891,23 @@
 
 /* Now define the toplevel functions.  */
 #include <iconv/skeleton.c>
+
+/* Initialization: fill the holes in __fourbyte_to_ucs table */
+__attribute__((constructor))
+static void initialize_gb18030()
+{
+    int i;
+    int lastz = 0;
+    for (i = 0; i < sizeof(__fourbyte_to_ucs) / sizeof(__fourbyte_to_ucs[0]); i++)
+    {
+        if (__fourbyte_to_ucs[i] == 0 && i > 0)
+        {
+            __fourbyte_to_ucs[i] = __fourbyte_to_ucs[i-1] + 1;
+            lastz = 1;
+        }
+        else
+        {
+            lastz = 0;
+        }
+    }
+}
